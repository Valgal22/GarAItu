package me.sebz.mu.pbl5;

import static com.codename1.ui.CN.*;
import com.codename1.system.Lifecycle;
import com.codename1.ui.*;
import com.codename1.ui.layouts.*;
import com.codename1.io.*;
import com.codename1.ui.plaf.*;
import com.codename1.ui.util.Resources;

/**
 * This file was generated by <a href="https://www.codenameone.com/">Codename
 * One</a> for the purpose
 * of building native mobile applications using Java.
 */
public class MemoryLens extends Lifecycle {
    private static String sessionToken;
    private static Long memberId;
    private static Long familyGroupId;
    private static String userRole;
    private static boolean hasEmbedding; // New field

    public static boolean hasEmbedding() {
        return hasEmbedding;
    }

    public static void setHasEmbedding(boolean value) {
        hasEmbedding = value;
    }

    public static String getSessionToken() {
        return sessionToken;
    }

    public static void setSessionToken(String token) {
        sessionToken = token;
    }

    public static Long getMemberId() {
        return memberId;
    }

    public static void setMemberId(Long id) {
        memberId = id;
    }

    public static Long getFamilyGroupId() {
        return familyGroupId;
    }

    public static void setFamilyGroupId(Long id) {
        familyGroupId = id;
    }

    public static String getUserRole() {
        return userRole;
    }

    public static void setUserRole(String role) {
        userRole = role;
    }

    public static void navigateToAppropriateDashboard() {
        Display.getInstance().callSerially(() -> {
            if (familyGroupId == null) {
                new GroupOnboardingForm().show();
                return;
            }

            String roleShort = userRole;
            if (roleShort == null)
                roleShort = "2"; // Default fallback
            // Handle "0.0" or "0"
            if (roleShort.startsWith("0") || "ADMIN".equalsIgnoreCase(roleShort)) {
                new AdminDashboard().show();
            } else if (roleShort.startsWith("1") || "PATIENT".equalsIgnoreCase(roleShort)) {
                new PatientDashboard().show();
            } else {
                // Default fallback to Family Dashboard for "2" or anything else unknown (safe
                // fail)
                new FamilyDashboard().show();
            }
        });
    }

    @Override
    public void runApp() {
        showLoginScreen();
    }

    public static void logout() {
        showLoginScreen();
    }

    public static void showLoginScreen() {
        Form loginForm = new Form("Login", new BorderLayout());

        Container center = new Container(BoxLayout.y());
        center.setScrollableY(true);
        center.getAllStyles().setPadding(10, 10, 10, 10);

        Label title = new Label("MemoryLens");
        title.setUIID("Title");
        title.getAllStyles().setAlignment(Component.CENTER);
        title.getAllStyles().setMarginBottom(10);

        TextField emailField = new TextField("", "Email", 20, TextField.EMAILADDR);
        emailField.setUIID("TextField");

        TextField passwordField = new TextField("", "Password", 20, TextField.PASSWORD);
        passwordField.setUIID("TextField");

        Button loginButton = new Button("Login");
        loginButton.setMaterialIcon(FontImage.MATERIAL_LOGIN, 5);

        Button registerButton = new Button("Register");
        registerButton.setUIID("ButtonSecondary");
        registerButton.setMaterialIcon(FontImage.MATERIAL_PERSON_ADD, 5);
        registerButton.addActionListener(e -> new RegistrationForm().show());

        loginButton.addActionListener(e -> {
            String email = emailField.getText();
            String password = passwordField.getText();

            if (email.isEmpty() || password.isEmpty()) {
                Dialog.show("Error", "Please fill all fields", "OK", null);
                return;
            }

            if (!email.contains("@") || !email.contains(".")) {
                Dialog.show("Invalid Email", "Please enter a valid email address", "OK", null);
                return;
            }

            // Real Login API Call via Node-RED
            java.util.Map<String, Object> loginData = new java.util.HashMap<>();
            loginData.put("email", email);
            loginData.put("password", password);

            GenericNetworkService.getInstance().post("/api/auth/login", loginData,
                    new GenericNetworkService.NetworkCallback() {
                        @Override
                        public void onSuccess(java.util.Map<String, Object> response) {
                            System.out.println("DEBUG: Login Response: " + response); // LOG ADDED
                            String roleShort = String.valueOf(response.get("role"));
                            String token = (String) response.get("session");
                            Object fgIdObj = response.get("familyGroupId");
                            Long fgId = (fgIdObj instanceof Number) ? ((Number) fgIdObj).longValue() : null;

                            Object mIdObj = response.get("memberId");
                            Long mId = (mIdObj instanceof Number) ? ((Number) mIdObj).longValue() : null;

                            // Extract hasEmbedding
                            boolean hasEmb = false;
                            if (response.containsKey("hasEmbedding")) {
                                Object urObj = response.get("hasEmbedding");
                                if (urObj instanceof Boolean)
                                    hasEmb = (Boolean) urObj;
                                else if (urObj instanceof String)
                                    hasEmb = Boolean.parseBoolean((String) urObj);
                            }

                            MemoryLens.setSessionToken(token);
                            MemoryLens.setFamilyGroupId(fgId);
                            MemoryLens.setMemberId(mId);
                            MemoryLens.setUserRole(roleShort);
                            MemoryLens.setHasEmbedding(hasEmb); // Set it

                            MemoryLens.navigateToAppropriateDashboard();
                        }

                        @Override
                        public void onFailure(String errorMessage) {
                            Display.getInstance().callSerially(() -> {
                                Dialog.show("Login Failed", errorMessage, "OK", null);
                            });
                        }
                    });
        });

        center.add(title);
        center.add(new Label("Welcome Back"));
        center.add(emailField);
        center.add(passwordField);
        center.add(loginButton);
        center.add(registerButton);

        loginForm.add(BorderLayout.CENTER, center);
        loginForm.show();
    }
}
